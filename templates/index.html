<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Smart Farming - Analyse</title>
    <style>
        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #198754;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark mb-4 p-3 shadow">
        <div class="container d-flex justify-content-between">
            <a class="navbar-brand fw-bold" href="/">üå± SMART AGRICULTURE</a>
            <div>
                <a href="/historique" class="btn btn-outline-light btn-sm me-2">Historique</a>
                <a href="/settings" class="btn btn-outline-secondary btn-sm text-white me-2">‚öôÔ∏è</a>
                <a href="/logout" class="btn btn-danger btn-sm">
                    <i class="bi bi-box-arrow-right"></i> D√©connexion
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-md-5">
                <div class="card shadow p-4 border-0">
                    <h4 class="text-success mb-3"><i class="bi bi-moisture"></i> Donn√©es Capteurs</h4>
                    <form method="POST" id="analysisForm">
                        <label class="small text-muted">Type de culture</label>
                        <select name="crop_type" class="form-select mb-3">
                            <option value="Riz">Riz</option>
                            <option value="Mais">Ma√Øs</option>
                            <option value="Ble">Bl√©</option>
                        </select>

                        <label class="small text-muted">Azote (N)</label>
                        <input type="number" name="n" placeholder="Ex: 40" class="form-control mb-3" required step="0.1">

                        <label class="small text-muted">Phosphore (P)</label>
                        <input type="number" name="p" placeholder="Ex: 50" class="form-control mb-3" required step="0.1">

                        <label class="small text-muted">Potassium (K)</label>
                        <input type="number" name="k" placeholder="Ex: 35" class="form-control mb-3" required step="0.1">

                        <label class="small text-muted">Temp√©rature (¬∞C)</label>
                        <input type="number" name="temp" placeholder="Ex: 28" class="form-control mb-3" required step="0.1">

                        <button type="submit" class="btn btn-success w-100 fw-bold" id="submitBtn">
                            <span id="btnText">Lancer l'Analyse</span>
                        </button>
                    </form>
                </div>
            </div>

            <div class="col-md-7">
                {% if prediction %}
                <div class="card shadow p-4 border-start border-5 border-success">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4 class="text-success m-0"><i class="bi bi-clipboard-check"></i> Rapport d'Expertise IA</h4>
                        <span class="badge bg-success fs-6">{{ "%.2f"|format(prediction) }}/5</span>
                    </div>
                    <p class="text-muted small">Culture analys√©e : <strong>{{ analyse.crop }}</strong></p>
                    <hr>
                    <div class="row mb-4">
                        <div class="col-6">
                            <p class="mb-2">üíß <strong>Irrigation :</strong><br> <span class="badge bg-light text-dark border">{{ analyse.irrigation }}</span></p>
                            <p class="mb-0">üåø <strong>Fertilisation :</strong><br> <span class="badge bg-light text-dark border">{{ analyse.fertilisation }}</span></p>
                        </div>
                        <div class="col-6 text-end">
                            <p class="mb-2">‚ôªÔ∏è <strong>Gaspillage :</strong><br> <span class="badge bg-light text-dark border">{{ analyse.gaspillage }}</span></p>
                            <p class="small text-muted mt-2">N:{{analyse.n}}, P:{{analyse.p}}, K:{{analyse.k}}, T:{{analyse.temp}}¬∞</p>
                        </div>
                    </div>
                    
                    <div style="height: 200px;">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <script>
                    new Chart(document.getElementById('barChart'), {
                        type: 'bar',
                        data: {
                            labels: ['Azote (N)', 'Phosphore (P)', 'Potassium (K)'],
                            datasets: [{ 
                                label: 'Concentration Nutriments', 
                                data: [{{analyse.n}}, {{analyse.p}}, {{analyse.k}}], 
                                backgroundColor: ['#198754', '#0d6efd', '#ffc107'],
                                borderRadius: 5
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: { y: { beginAtZero: true } }
                        }
                    });
                </script>
                {% else %}
                <div class="text-center mt-5 text-muted border p-5 bg-white shadow-sm rounded border-0">
                    <i class="bi bi-cpu fs-1 text-success"></i>
                    <h5 class="mt-3">Syst√®me Pr√™t</h5>
                    <p>Veuillez entrer les donn√©es de vos capteurs pour g√©n√©rer une analyse pr√©dictive.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Petit script pour animer le bouton lors du clic
        document.getElementById('analysisForm').onsubmit = function() {
            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loader"></span> Analyse en cours...';
        };
    </script>
</body>
</html>